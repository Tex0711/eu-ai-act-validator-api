# EU AI Act Compliance Engine (Rust)

Idiomatic Rust reimplementation of the **ComplianceEngine** with **Article-Specific Filtering (ASCF)** and **Triple Semantic Representation** (formal text + simplified explanation + real-world examples). Target: **&lt;100 ms** latency using efficient vector math.

## Install Rust (macOS / Linux)

If `cargo` is not found, install Rust with rustup (includes Cargo):

```bash
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
```

Choose the default installation, then **restart your terminal** (or run `source "$HOME/.cargo/env"`). Verify:

```bash
cargo --version
```

Alternatively with Homebrew: `brew install rustup` then `rustup default stable`.

## Build & test

```bash
cargo build --release
cargo test
```

You should see **6 tests passed** (vector cosine + engine decision rules). Use plain `cargo test` (debug build); if you ever see "6 ignored" when using `cargo bench`, run `cargo test -- --include-ignored` to run the same tests.

The benchmark (`cargo bench`) reports **evaluate_single** latency (target &lt;100 ms; with 1 chunk you typically see ~2 µs).

## Max data volume under 100 ms

Measure time per chunk (c), compute **N_max** (max chunks at 100 ms), and write `data/max_volume_100ms.json`:

```bash
cargo run --release --bin scale_bench
```

Uses N = 100, 500, 1000, 2000, 5000, 10_000 chunks (500 evaluate calls each), computes **c** (µs/chunk), **N_max = 100 / c**, and **max_vector_data_mb**. Criterion scale benchmark (varying N):

```bash
cargo bench --bench scale_bench
```

### Benchmark result (Compliance Engine Rust – 100 ms scale benchmark)

- **Method:** In-memory brute-force O(N) over N chunks (1536-dim cosine, top-3, no ANN index).
- **Typical result:** ~1 µs/chunk → **N_max ≈ 90k chunks** within 100 ms; max vector data ≈ **~500 MB** (embeddings only).
- **Context:** Current knowledge base (~34 chunks) stays well under 1 ms; managed vector APIs often report 10–50 ms for 100k vectors. This engine reaches ~90k chunks under 100 ms without an index.

## Benchmark (36 scenarios)

With minimal fixtures (placeholder embeddings):

```bash
cargo run --release -- benchmark
```

For **real accuracy**, generate embeddings and knowledge from the main app. Run the export from the **repo root** (the folder that contains `engine-rust`), not from inside `engine-rust`:

```bash
cd ..   # if you are in engine-rust, go to compliance-code
node scripts/export-for-rust-engine.js
```

Then run the benchmark (from repo root or from `engine-rust`):

```bash
cd engine-rust
cargo run --release -- benchmark
```

Requires `OPENAI_API_KEY` and Supabase env vars for the export script.

Data paths (defaults):

- `data/knowledge.json` – compliance chunks with embeddings (export from Supabase or use fixture)
- `data/scenarios_36.csv` – 36 test prompts + expected decision (ALLOW/DENY/WARNING)
- `data/prompt_embeddings.json` – optional; if missing, placeholder embeddings are used (latency-only benchmark)

## Single evaluation

Pipe a 1536-dim embedding (JSON array) to stdin:

```bash
echo '[0.1, 0.2, ...]' | cargo run --release -- eval
```

## Architecture

- **Vector math:** loop-unrolled cosine similarity (8x) for 1536-dim embeddings; `ndarray` available for alternative use.
- **Decision rules:** top-k semantic search → if top article is Article 5(1) → DENY; if Article 6 / Annex III → WARNING; else ALLOW.
- **No LLM in Rust:** this engine performs only retrieval + rule-based decision; use the Node API for full Gemini-based reasoning. Benchmark accuracy is typically **~78%** (36 scenarios); the Node API reaches **~94%** with Gemini.

## Files

- `src/vector.rs` – cosine similarity (ndarray + unrolled)
- `src/engine.rs` – ComplianceEngine, search, ASCF decision
- `src/main.rs` – CLI: `benchmark`, `eval`
- `src/bin/scale_bench.rs` – measure c, N_max, write `data/max_volume_100ms.json`
- `benches/scale_bench.rs` – Criterion benchmark for varying N
- `data/scenarios_36.csv` – same 36 scenarios as the JS accuracy test
- `data/max_volume_100ms.json` – generated by `cargo run --release --bin scale_bench`
